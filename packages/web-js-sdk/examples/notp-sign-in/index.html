<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="/../dist/index.umd.js"></script>
  </head>
  <body>
    <div>
      <h2>NOTP Sign In</h2>
      <h1>What's your project ID?</h1>
      <h4>P2eaLQZXWWPuQ2qKfXZY55kr4EYF</h4>
      <form>
        <input name="input" type="text" />
        <button type="submit">Submit</button>
      </form>
    </div>

    <script>
      let sdk;
      let step = 0;

      let pendingRefState;

      const formEle = document.getElementsByTagName('form')[0];
      const h1Ele = document.getElementsByTagName('h1')[0];
      const h4Ele = document.getElementsByTagName('h4')[0];
      const inputEle = document.getElementsByTagName('input')[0];

      formEle.onsubmit = async function (e) {
        e.preventDefault();
        const input = new FormData(e.target).get('input');
        console.log('step', step);
        console.log('input', input);
        if (step === 0) {
          // Step 0
          sdk = Descope({ projectId: input, baseUrl: 'http://localhost:8000' });
          h1Ele.innerText = "What's your phone?";
          h4Ele.innerText = '+972545365008';
          inputEle.value = '';
          input.placeholder = 'e.g. +1234567890';

          // Add another input for custom claim named "K1"
          const k1Input = document.createElement('input');
          k1Input.name = 'K1';
          k1Input.type = 'text';
          k1Input.placeholder = 'e.g. V1';
          formEle.appendChild(k1Input);


        } else if (step === 1) {
          // Step 1
          h1Ele.innerText =
            'Click on button or scan QR code to sign up or sign in';

          // get custom claim K1
          const K1 = new FormData(e.target).get('K1');
          console.log('K1', K1);

          const res = await sdk.notp.signIn(input, { customClaims: { K1 } });
          console.log('res', res);
          if (!res.ok) {
            alert(JSON.stringify(res, null, 4));
            return;
          }
          const { QRCode, pendingRef, redirectUrl } = res.data;

          // create a new image element with the base64 string image
          const img = new Image();
          img.src = `data:image/png;base64, ${QRCode}`;
          document.body.appendChild(img);

          // Add a link with the redirectUrl
          const a = document.createElement('a');
          a.setAttribute('href', redirectUrl);
          a.setAttribute('target', '_blank');
          const continueNode = document.createTextNode('Continue');
          a.appendChild(continueNode);

          // put the link in a paragraph
          const aWrapper = document.createElement('p');
          aWrapper.appendChild(a);
          document.body.appendChild(aWrapper);

          // show pendingRef
          const p = document.createElement('p');
          p.appendChild(document.createTextNode(`pendingRef: ${pendingRef}`));
          document.body.appendChild(p);

          // add another p with text of text query param of redirectUrl
          const p2 = document.createElement('p');
          const url = new URL(redirectUrl);
          const text = url.searchParams.get('text');
          p2.appendChild(document.createTextNode(`text: ${text}`));
          document.body.appendChild(p2);

          // add copy button to copy the text
          const button = document.createElement('button');
          button.innerText = 'Copy text';
          button.onclick = () => {
            navigator.clipboard.writeText(text);
          };

          // put the button in a paragraph
          const buttonWrapper = document.createElement('p');
          buttonWrapper.appendChild(button);
          document.body.appendChild(buttonWrapper);

          // save pendingRef
          pendingRefState = pendingRef;

          // hide input
          inputEle.style.display = 'none';

          // change text button to "Check pendingRef"
          formEle.getElementsByTagName('button')[0].innerText =
            'Check pendingRef';
        } else if (step === 2) {
          // Step 2
          // show loading spinner
          const p = document.createElement('p');
          p.appendChild(document.createTextNode('Checking pendingRef...'));
          document.body.appendChild(p);

          const res = await sdk.notp.getSession(pendingRefState);

          if (!res.ok) {
            alert(JSON.stringify(res, null, 4));
            return;
          }

          // remove loader
          document.body.removeChild(p);

          // show data to user
          const p2 = document.createElement('p');
          p2.appendChild(
            document.createTextNode(JSON.stringify(res.data, null, 4)),
          );
          document.body.appendChild(p2);
        }

        step++;
      };
    </script>
  </body>
</html>
